# Документация API Campfire Web

Campfire Web делает небольшую обертку вокруг обычного
API Campfire, чтобы им было легче пользоваться. Также
через Campfire Web можно делать некоторые запросы без
наличия авторизации в Campfire.

## Общая структура

Большинство запросов используют параметры GET (после `?`
или в самом пути) для указания опций запроса. В случае
ошибки сервер вернет ошибочный код HTTP и если удалось
определить ошибку, похожий JSON-объект:

```json
{
  "error": true,
  "response": {
    "code": "MISSING_ARGUMENT",
    "messageError": "An argument is missing",
    "params": []
  }
}
```

Эти данные могут идти как от самого сервера Campfire,
так и от Campfire Web. Все ошибки от Campfire Web в
`J_RESPONSE` имеют `"cweb": true`.

## Токены авторизации

Токены авторизации (получаются из `/api/auth/login`)
можно указать через cookie-файлы. Сервер также может
отправить их в любом запросе, не только в `/api/auth/login`.

Список кук:
* `token` указывается в `J_API_ACCESS_TOKEN`
* `refreshToken` указывается в `J_API_REFRESH_TOKEN`
  (не используется сервером Campfire)
* `loginToken` указывается в `J_API_LOGIN_TOKEN`

Если авторизация по `token` (`refreshToken`) не прошла,
то сервер будет использовать `loginToken`.

## Параметры

Обычно параметры для запроса передаются в параметрах
GET (после `?`), но в некоторых запросах данные нужно
передавать через тело POST-запроса. Какие параметры POST,
а какие GET обозначено.

Примеры параметров:
* `[hello]`: Параметр в пути к запросу с названием `hello`.
  Чтобы указать надо просто заменить его в пути на нужное
  значение.
* `?hello=`: Обычный обязательный параметр с названием `hello`
* `?hello=1`: Обычный необязательный параметр с названием
  `hello` и значением по умолчанию `1`

## Запросы

Базовый URL: `https://camp.33rd.dev/`.
Все вопросы мне в ЛС (https://camp.33rd.dev/r/sit) или
в Issues.

Полную схему ответов я тут расписывать не буду, она
пересылается напрямую из сервера Campfire.

### /api/account/

#### /api/account/[id/name]/

Получает данные о профиле и аккаунте.

Параметры:
* `[id/name]`: ID или ник аккаунта

#### /api/account/[id]/publications

Получает посты и комментарии у пользователя.

Параметры:
* `[id]`: ID аккаунта
* `?offset=0`: Сколько публикаций пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** если будет создана
> публикация во время пролистывания, то предыдущие элементы
> появятся несколько раз. А ведь эта проблема была уже
> решена в ленте и комментах (где это кстати применимо
> только если комментарий удалили, после чего коммент
> скипнется).

### /api/activity/

#### /api/activity/[id]/

Получает данные об эстафете.

Параметры:
* `[id]`: ID эстафеты

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** `tag_2` в информации
> об эстафете это время её передачи следующему человеку.

#### /api/activity/[id]/posts

Получает последние посты в эстафете.

Параметры:
* `[id]`: ID эстафеты
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id/name]/publications`, та же проблема.

#### /api/activity/[id]/member

Изменить статус участия в эстафете.

> Заметка: если пришла ваша очередь, то чтобы отказаться
> надо использовать `/api/activity/[id]/reject`.

Параметры:
* `[id]`: ID эстафеты
* `?member=`: Строго `true` чтобы принять участие,
  `false` чтобы не участвовать

#### /api/activity/[id]/reject

Отказаться от участия в эстафете.

Параметры:
* `[id]`: ID эстафеты

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** `currentOwnerTime` это
> как `tag_2` в `/api/activity/[id]`. 

### /api/auth/

#### /api/auth/login

Входит в аккаунт по email и паролю.

Важное напоминание: этот запрос после входа
переадресует либо на главную страницу, либо на
страницу входа с ошибкой. Куки все равно ставит.

Параметры POST:
* `email`: Собственно email-адрес
* `password`: Собственно пароль, в сыром виде (не MD5,
  чтобы на фронтэнде можно было использовать `<form>`
  без "украшений" из JS)
* `redir=true`: `true` чтобы переадресовать запрос на
  `/` или `/auth/login`. `false` чтобы отправить ответ
  от сервера.

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** на самом деле сервер
> не берет сырой пароль, а зачем-то его MD5 хэш. То есть
> если базу данных Campfire взломают (даже read-only),
> то можно будет войти в любой аккаунт (с email).

#### /api/auth/logout

Просто убирает все куки для входа и переадресует на
главную страницу.

### /api/drafts/

#### /api/drafts/

Получает список черновиков.

Параметры:
* `?offset=0`: Сколько надо постов пропустить

#### /api/drafts/[id]/

Получает один черновик по ID.

Параметры:
* `[id]`: ID черновика

#### /api/drafts/[id]/page

Совершает действие со страницами в черновике.

Параметры:
* `[id]`: ID черновика
* `?action=`: Действие. Одно из:
  * `put`: Добавляет страницы в конец
  * `remove`: Удаляет страницы
  * `move`: Перемещает страницу
  * `change`: Изменяет страницу

Параметры POST зависят от выбранного `?action`:
* `put`:
  ```json
  {
    "fandomId": 10,
    "languageId": 2,
    "pages": [
      {
        "J_PAGE_TYPE": 1,
        "J_TEXT": "Hello, world",
        "J_SIZE": 0,
        "align": 0,
        "icon": 0
      }
    ]
  }
  ```
* `remove`:
  ```json
  {
    "pageIndexes": [0, 3]
  }
  ```
* `move`:
  ```json
  {
    "pageIndex": 3,
    "targetIndex": 0
  }
  ```
* `change`:
  ```json
  {
    "pageIndex": 0,
    "page": {
      "J_PAGE_TYPE": 1,
      "J_TEXT": "Bye, world!",
      "J_SIZE": 0,
      "align": 1,
      "icon": 0
    }
  }
  ```

Типы страниц берите из
[ZeonXX/CampfireAPI](https://github.com/ZeonXX/CampfireAPI)
в папке `src/main/.../models/publication/post`. Их `J_PAGE_TYPE`
указаны в `API.kt`.

Кому не понятно, что это все означает, пишите в ЛС,
но за свою токсичность (иногда) я не отвечаю.

#### /api/drafts/[id]/publish

Публикует черновик.

Параметры:
* `[id]`: ID черновика

Параметры POST:
* `tags=[]`: Массив ID тегов поста. Указывать категории
  тегов не обязательно
* `notify=false`: Посылать уведомление подписчикам
* `pendingTime=0`: Timestamp в миллисекундах когда надо
  запланировать пост
* `closed=false`: Закрытый пост
* `multilingual=false`: Мультиязычный пост
* `rubricId=0`: ID рубрики
* `userActivityId=0`: ID эстафеты
* `userActivityNextId=0`: ID аккаунта кому передать эстафету
  или `0` для рандома

### /api/fandom/

#### /api/fandom/

Получает первые фэндомы в списке фэндомов.

Заметка: `?offset` не работает когда `?card=true`.

Параметры:
* `?offset=0`: Сколько фэндомов пропустить
* `&card=false`: Если указан, перемешивает их.

#### /api/fandom/[id]/

Получает всю информацию о фэндоме.

Параметры:
* `[id]`: ID фэндома

#### /api/fandom/[id]/posts

Получает посты в фэндоме.

Параметры:
* `[id]`: ID фэндома
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id/name]/publications`, та же проблема.

#### /api/fandom/[id]/sub

Изменить статус подписки на фэндом.

Параметры:
* `[id]`: ID фэндома
* `?type=`: Тип подписки. Один из:
  * `1`: Без подписки
  * `0`: Всё
  * `-1`: Только важное
* `&important=`: Строго `true` чтобы уведомлять о важных
  постах, `false` чтобы не уведомлять. По умолчанию `true`,
  но только если `type != 1`.

#### /api/fandom/[id]/wiki/

Получает список из корня вики фэндома.

Параметры:
* `[id]`: ID фэндома
* `?offset=0`: Сколько элементов пропустить

#### /api/fandom/[id]/wiki/[wikiId]/

Получает список из какого-то раздела вики фэндома.

Параметры:
* `[id]`: ID фэндома
* `[wikiId]`: `itemId` раздела, см. ниже
* `?offset=0`: Сколько элементов пропустить

> Заметка: **не путайте** `id` и `itemId` (спасибо, Zeon).
> Его можно получить из другого раздела вики или из корня
> (`/api/fandom/[id]/wiki/`).

#### /api/fandom/wiki/[wikiId]/

Получает страницу из вики.

> Заметка: обратите внимание, тут в адресе не надо указывать
> ID фэндома.

* `[wikiId]`: `itemId` раздела, см. ниже

### /api/image

#### /api/image/[id]

Загружает изображение с сервера. В конце можно
добавить расширение `.jpg`, преобразуется обратно.

Параметры:
* `[id]`: ID картинки

### /api/post/

#### /api/post/search

Ищет посты.

Параметры:
* `?q=`: Поисковой запрос

#### /api/post/[id]

Получает пост и его теги.

Параметры:
* `[id]`: ID поста

#### /api/post/[id]/comments

Получает комментарии у *любой публикации*, не только у поста.
Говнокод у меня вышел. :)

Параметры:
* `[id]`: ID поста
* `?offset=0`: `dateCreate` последнего комментария или `0`

### /api/project/

#### /api/project/donates

Получает количество пожертвованных рублей (умноженное на
100, чтобы не было дробных значений).

### /api/pub/

#### /api/pub/[id]/comment

Создает комментарий под публикацией. Запрос POST!

Параметры:
* `[id]`: ID публикации

Параметры POST:
* `content`: Содержание комментария
* `reply`: ID комментария, на который отвечают или `0` по
  умолчанию

#### /api/pub/[id]/karma

Поставить карму на публикации.

Параметры:
* `[id]`: ID публикации
* `?positive=false`: строго `true` для положительной, `false`
  для отрицательной кармы

### /api/rubric/

#### /api/rubric/[id]

Совмещенный запрос:
* Получает информацию о рубрике (если `?offset=0`)
* Получает посты из рубрики (всегда)

Параметры:
* `[id]`: ID рубрики
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id]/publications`, та же проблема.

### /api/user/

#### /api/user/

Получает информацию о текущем пользователе.

#### /api/user/quest/

Получает информацию о ежедневном квесте у текущего
пользователя.

### /api/

#### /api/custom

Свой сырой запрос к серверу Campfire. В данных POST
указывается JSON-объект, который надо передать. Токены
и обязательные поля заполняются Campfire Web.

#### /api/feed

Получает посты из ленты.

Параметры:
* `?offset=0`: `dateCreate` последнего поста или `0`
* `&type=subscribed`: Тип ленты. Один из:
  * `subscribed`: Подписки
  * `all`: Всё
  * `best`: Лучшее
  * `good`: Хорошее
  * `abyss`: Бездна
  * `all_subs`: Всё (+ подписки)

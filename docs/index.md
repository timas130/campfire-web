# Документация API Campfire Web

Campfire Web делает небольшую обертку вокруг обычного
API Campfire, чтобы им было легче пользоваться. Также
через Campfire Web можно делать некоторые запросы без
наличия авторизации в Campfire.

## Общая структура

Большинство запросов используют параметры GET (после `?`
или в самом пути) для указания опций запроса. В случае
ошибки сервер вернет ошибочный код HTTP и если удалось
определить ошибку, похожий JSON-объект:

```json
{
  "error": true,
  "response": {
    "code": "MISSING_ARGUMENT",
    "messageError": "An argument is missing",
    "params": []
  }
}
```

Эти данные могут идти как от самого сервера Campfire,
так и от Campfire Web.

## Токены авторизации

Токены авторизации (получаются из `/api/auth/login`)
можно указать через cookie-файлы. Сервер также может
отправить их в любом запросе, не только в `/api/auth/login`.

Список кук:
* `token` указывается в `J_API_ACCESS_TOKEN`
* `refreshToken` указывается в `J_API_REFRESH_TOKEN`
  (не используется сервером Campfire)
* `loginToken` указывается в `J_API_LOGIN_TOKEN`

Если авторизация по `token` (`refreshToken`) не прошла,
то сервер будет использовать `loginToken`.

## Запросы

Базовый URL: `https://camp.33rd.dev/`.
Все вопросы мне в ЛС (https://camp.33rd.dev/r/sit) или
в Issues.

Полную схему ответов я тут расписывать не буду, она
пересылается напрямую из сервера Campfire.

### /api/account/

#### /api/account/[id/name]/

Получает данные о профиле и аккаунте.

Параметры:
* `[id/name]`: ID или ник аккаунта

#### /api/account/[id/name]/publications

Получает посты и комментарии у пользователя.

Параметры:
* `[id/name]`: ID или ник аккаунта
* `?offset=0`: Сколько публикаций пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** если будет создана
> публикация во время пролистывания, то предыдущие элементы
> появятся несколько раз. А ведь эта проблема была уже
> решена в ленте и комментах (где это кстати применимо
> только если комментарий удалили, после чего коммент
> скипнется).

### /api/activity/

#### /api/activity/[id]/

Получает данные об эстафете.

Параметры:
* `[id]`: ID эстафеты

#### /api/activity/[id]/posts

Получает последние посты в эстафете.

Параметры:
* `[id]`: ID эстафеты
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id/name]/publications`, та же проблема.

### /api/auth/

#### /api/auth/login

Входит в аккаунт по email и паролю.

Важное напоминание: этот запрос после входа
переадресует либо на главную страницу, либо на
страницу входа с ошибкой. Куки все равно ставит.

Параметры POST:
* `email`: Собственно email-адрес
* `password`: Собственно пароль, в сыром виде (не MD5,
  чтобы на фронтэнде можно было использовать `<form>`
  без "украшений" из JS)

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** на самом деле сервер
> не берет сырой пароль, а зачем-то его MD5 хэш. То есть
> если базу данных Campfire взломают (даже read-only),
> то можно будет войти в любой аккаунт (с email).

#### /api/auth/logout

Просто убирает все куки для входа и переадресует на
главную страницу.

### /api/fandom/

#### /api/fandom/[id]/

Получает всю информацию о фэндоме.

Параметры:
* `[id]`: ID фэндома

#### /api/fandom/[id]/posts

Получает посты в фэндоме.

Параметры:
* `[id]`: ID фэндома
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id/name]/publications`, та же проблема.

### /api/image

#### /api/image/[id]

Загружает изображение с сервера. В конце можно
добавить расширение `.jpg`, преобразуется обратно.

Параметры:
* `[id]`: ID картинки

### /api/post/

#### /api/post/search

Ищет посты.

Параметры:
* `?q=`: Поисковой запрос

#### /api/post/[id]

Получает пост и его теги.

Параметры:
* `[id]`: ID поста

#### /api/post/[id]/comments

Получает комментарии у *любой публикации*, не только у поста.
Говнокод у меня вышел. :)

Параметры:
* `[id]`: ID поста
* `?offset=0`: `dateCreate` последнего комментария или `0`

### /api/project/

#### /api/project/donates

Получает количество пожертвованных рублей (умноженное на
100, чтобы не было дробных значений).

### /api/pub/

#### /api/pub/[id]/comment

Создает комментарий под публикацией.

Параметры:
* `[id]`: ID публикации
* `?content=`: Содержание комментария
* `&reply=0`: ID комментария, на который отвечают

#### /api/pub/[id]/karma

Поставить карму на публикации.

Параметры:
* `[id]`: ID публикации
* `?positive=false`: строго `true` для положительной, `false`
  для отрицательной кармы

### /api/rubric/

#### /api/rubric/[id]

Совмещенный запрос:
* Получает информацию о рубрике (если `?offset=0`)
* Получает посты из рубрики (всегда)

Параметры:
* `[id]`: ID рубрики
* `?offset=0`: Сколько постов пропустить в начале

> **РУБРИКА "ГОВНОКОД ОТ ЗЕОНА":** см.
> `/api/account/[id/name]/publications`, та же проблема.

### /api/user/

#### /api/user/

Получает информацию о текущем пользователе.

#### /api/quest

Получает информацию о ежедневном квесте у текущего
пользователя.

### /api/

#### /api/custom

Свой сырой запрос к серверу Campfire. В данных POST
указывается JSON-объект, который надо передать. Токены
и обязательные поля заполняются Campfire Web.

#### /api/fandoms

Получает первые фэндомы в списке фэндомов.

Параметры:
* `?card`: Если указан, перемешивает их

#### /api/feed

Получает посты из ленты.

Параметры:
* `?offset=0`: `dateCreate` последнего поста или `0`

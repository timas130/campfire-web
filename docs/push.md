# PushRelay

PushRelay™ это простой сервис, который позволяет получать
уведомления из Campfire и не только, используя простой API.

## Почему ™?

Так звучит смешнее. Я даже не знаю зачем я придумал этой
штуке название.

## Референс

Базовый URL: `https://push.33rd.dev`.

### /register

Создать новый токен в системе. Если не будет подключения
в `/stream` через 60 секунд, то он отзывается и пропадает.

В ответ отправляет `listenToken` и `sendToken`, которые
используются для получения и отправки уведомлений соотв.

Параметры:
* `?campfire=true`: Надо ли регистрировать `loginToken`,
  указанный в body. Если `false`, то запрос может быть через
  метод `GET`.

Параметры POST:
* `loginToken`: Токен входа из Campfire. Он используется,
  чтобы регистрировать и отозвать токены в сервере Campfire.
  То же самое, что и в `docs/index.md`.

### /stream

WebSocket для принятия уведомлений.

Заголовки:
* `Authorization`: В этом заголовке надо указать
  `listenToken`, полученный в `/register`.

Каждые 10 секунд сервер отправляет пакет, который содержит
простую строку `{"_": "keep-alive"}`, этот пакет можно
игнорировать.

Все сообщения от сервера это уведомления, которые
закодированы через `JSON.stringify`. Короче, если через
Campfire, то всегда отправляется простой JSON (не совсем,
но увидите в ходе тестов).

При отключении от сокета токен `listenToken` пропадает
через 30 секунд. Если переподключиться, то уведомления
всё ещё будут приходить, даже если отключение было из-за
бага PushRelay.

### /push

Отправить уведомление.

Параметры POST:
* `registration_ids`: Список `sendToken`, которым послать
  уведомления.
* `data`: Данные уведомления, которые будут получены в
  `/stream`.

Пример запроса:
```json
{
  "registration_ids": ["<sendToken 1>", "<sendToken 2>"],
  "data": {"hello": "world"}
}
```

Пример ответа:
```json
{
  "results": [
    { "message_id": "cweb" },
    { "message_id": "cweb", "error": "NotRegistered" }
  ]
}
```
